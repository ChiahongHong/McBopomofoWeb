<html>

<head>
    <meta charset="utf-8">
    <title>McBopomofo Example</title>
    <style>
        body {
            font-family: Arial, Helvetica, sans-serif;
            font-size: 14pt;
            margin: 20px;
        }

        textarea {
            background-color: blue;
            font-size: 14pt;
            color: #FFF;
            border: 0;
            padding: 10px;
            width: 100%;
            height: 300px;
        }

        .function {
            border: 1px solid #CCC;
            padding: 10px;
            height: 4em;
            background-color: green;
            color: #FFF;
        }

        .function table {
            font-size: 12pt;
            color: #FFF;
        }

        #candidates {
            margin-top: 10px;
        }

        .left {
            width: 70%;
            float: left;
        }

        .right {
            width: 25%;
            float: right;
            margin-left: 10px;
        }
    </style>
</head>

<bodY>
    <h1>McBopomofo Example</h1>
    <p>您不需要額外安裝中文輸入法，就可以在以下文字框用線上版小麥注音輸入中文</p>
    <div class="left">
        <textarea id="text_area" rows="10" cols="50"></textarea>
        <div class="function">
            <div class="composing_buffer" id="composing_buffer">【麥】</div>
            <div class="candidates" id="candidates"></div>
            <div class="tooltip" id="tooltip"></div>
        </div>
    </div>
    <div class="right">
        <h2>設定</h2>
        <table>
            <tr>
                <td>鍵盤配置：</td>
                <td>
                    <select id="layout">
                        <option value="Standard">標準</option>
                        <option value="ETen">倚天</option>
                        <option value="Hsu">許式</option>
                        <option value="ETen">倚天 26</option>
                        <option value="HanyuPinyin">漢語拼音</option>
                        <option value="IBM">IBM</option>
                    </select>
                </td>
            <tr>
                <td>選字模式：</td>
                <td>
                    <input type="radio" name="select_phrase" value="before_cursor" id="before_cursor"
                        checked="checked"><label for="before_cursor">選擇游標前的字詞</label><br>
                    <input type="radio" name="select_phrase" value="after_cursor" id="after_cursor"><label
                        for="after_cursor">選擇游標後的字詞</label>
                </td>
        </table>
    </div>
</bodY>


<script lang="javascript" src="../public/bundle.js"></script>
<script lang="javascript">
    var chineseMode = true;
    let ui = function () {
        let that = {};
        that.reset = function () {
            document.getElementById("composing_buffer").innerHTML = chineseMode ? "【麥】" : "【英】";
            document.getElementById("candidates").innerHTML = "";
            document.getElementById("tooltip").innerHTML = "";
        };

        that.commitString = function (string) {
            var selectionStart = document.getElementById("text_area").selectionStart;
            var selectionStop = document.getElementById("text_area").selectionStop;
            var text = document.getElementById("text_area").value;
            var head = text.substring(0, selectionStart);
            var tail = text.substring(selectionStart);
            document.getElementById("text_area").value = (head + string + tail);
            let start = selectionStart + string.length;
            document.getElementById("text_area").setSelectionRange(start, start)
        };

        that.update = function (string) {
            let state = JSON.parse(string);
            {
                let buffer = state.composingBuffer;
                let s = chineseMode ? "【麥】" : "【英】";
                let i = 0;
                for (let item of buffer) {
                    let text = item.text;
                    for (let c of text) {
                        if (i === state.cursorIndex) {
                            s += "|";
                        }
                        s += c;
                        i++;
                    }

                }
                if (i === state.cursorIndex) {
                    s += "|";
                }
                document.getElementById("composing_buffer").innerHTML = s;
            }

            if (state.candidates.length) {
                let s = "<table><tr>"
                for (let candidate of state.candidates) {
                    s += "<td>";
                    if (candidate.selected) s += "<b>";
                    s += candidate.keyCap;
                    if (candidate.selected) s += "</b>";
                    s += "</td>";
                    s += "<td>";
                    if (candidate.selected) s += "<b>";
                    s += candidate.candidate;
                    if (candidate.selected) s += "</b>";
                    s += "</td>";
                    if (candidate.selected) s += "</b>";
                }
                s += "</tr></table>";
                document.getElementById("candidates").innerHTML = s;
            }
            else if (state.tooltip.length) {
                document.getElementById("tooltip").innerHTML = state.tooltip;
            }

        };

        return that;
    }();
    const { InputController } = window.mcbopomofo;
    let controller = new InputController(ui);
    let shiftState = false;

    document.getElementById("text_area").addEventListener('keyup', (event) => {
        if (event.key === "Shift" && shiftState) {
            shiftState = false;
            chineseMode = !chineseMode;
            controller.reset();
            return;
        }
    });

    document.getElementById("text_area").addEventListener('keydown', (event) => {
        if (event.key === "Shift") {
            shiftState = true;
        } else {
            shiftState = false;
        }

        if (!chineseMode) {
            return;
        }

        let accepted = controller.keyEvent(event);
        if (accepted) {
            event.preventDefault();
        }
    });


    document.getElementById("layout").onchange = function (event) {
        let value = document.getElementById("layout").value;
        controller.setKeyboardLayout(value);
    };

    document.getElementById("before_cursor").onchange = function (event) {
        controller.setSelectPhrase("before_cursor");
    };

    document.getElementById("after_cursor").onchange = function (event) {
        controller.setSelectPhrase("after_cursor");
    };

    document.getElementById("text_area").focus();

</script>


</html>