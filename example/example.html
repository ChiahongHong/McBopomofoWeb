<html>

<head>
    <meta charset="utf-8">
    <title>McBopomofo Example</title>
    <style>
        body {
            font-family: Arial, Helvetica, sans-serif;
            font-size: 14pt;
            margin: 20px;
        }

        #edit_area {
            height: 70%;
        }

        textarea {
            background-color: gray;
            font-size: 14pt;
            color: #FFF;
            border: 0;
            padding: 10px;
            width: 100%;
            height: calc(100% - 4em);
        }

        textarea:focus {
            background-color: blue;
        }

        .function {
            border: 1px solid #CCC;
            padding: 10px;
            height: 4em;
            background-color: green;
            color: #FFF;
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            -khtml-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }

        .function table {
            font-size: 12pt;
            color: #FFF;
        }

        #candidates {
            font-size: 12pt;
            margin-top: 10px;
        }

        .left {
            width: 70%;
            float: left;
        }

        .right {
            width: 28%;
            float: right;
        }

        .right p,
        .right li {
            font-size: 10pt;
        }

        .option_title {
            text-align: right;
            vertical-align: top;
        }

        .main {
            max-width: 1320px;
            margin-left: auto;
            margin-right: auto;
        }

        .cursor {
            animation: blinker 1s linear infinite;
        }

        @keyframes blinker {
            50% {
                opacity: 0;
            }
        }
    </style>
</head>

<bodY>
    <div class="main">
        <p id="loading"><img src="https://cdnjs.cloudflare.com/ajax/libs/galleriffic/2.0.1/css/loader.gif" alt="載入中"
                height="20" width="20">
            正在載入小麥注音輸入法，請稍候</p>
        <div class="left">
            <div id="edit_area">
                <textarea id="text_area" rows="10" cols="50"></textarea>
                <div class="function">
                    <div class="composing_buffer" id="composing_buffer">【麥】</div>
                    <div class="candidates" id="candidates"></div>
                </div>
            </div>
        </div>
        <div class="right">
            <h2>設定</h2>
            <table>
                <tr>
                    <td class="option_title">鍵盤配置：</td>
                    <td>
                        <select id="layout">
                            <option value="Standard">標準</option>
                            <option value="ETen">倚天</option>
                            <option value="Hsu">許式</option>
                            <option value="ETen">倚天 26</option>
                            <option value="HanyuPinyin">漢語拼音</option>
                            <option value="IBM">IBM</option>
                        </select>
                    </td>
                </tr>
                <tr>
                    <td class="option_title">選字按鍵：</td>
                    <td>
                        <select id="keys">
                            <option value="123456789">123456789</option>
                            <option value="asdfghjkl">asdfghjkl</option>
                            <option value="asdfzxcvb">asdfzxcvb</option>
                        </select>
                    </td>
                </tr>
                <tr>
                    <td class="option_title">選字模式：</td>
                    <td>
                        <input type="radio" name="select_phrase" value="before_cursor" id="before_cursor"
                            checked="checked"><label for="before_cursor">選擇游標前的字詞</label><br>
                        <input type="radio" name="select_phrase" value="after_cursor" id="after_cursor"><label
                            for="after_cursor">選擇游標後的字詞</label><br>
                        <input type="checkbox" name="move_cursor" id="move_cursor"><label
                            for="move_cursor">選字之後自動移動游標</label>
                    </td>
                </tr>
                <tr>
                    <td class="option_title">ESC 按鍵：</td>
                    <td>
                        <input type="checkbox" name="esc_key" id="esc_key"><label for="esc_key">ESC
                            按鍵清除整個輸入緩衝區</label>
                    </td>
                </tr>
                <tr>
                    <td class="option_title">Shift + 字母：</td>
                    <td>
                        <input type="radio" name="letters" value="uppercase_letters" id="uppercase_letters"
                            checked="checked"><label for="uppercase_letters">輸入大寫字母</label><br>
                        <input type="radio" name="letters" value="lowercase_letters" id="lowercase_letters"><label
                            for="lowercase_letters">輸入小寫字母</label>
                    </td>
                </tr>
                <tr>
                    <td class="option_title">其他：</td>
                    <td>
                        <a href="#" id="fullscreen">全螢幕編輯</a>
                    </td>
                </tr>
            </table>
            <h2>說明</h2>
            <p>小麥注音是一套自動選字的注音輸入法，基本操作類似自然、酷音等。您可以在左方的輸入框中直接使用線上版本的小麥注音，無須安裝系統輸入法。使用方式如下</p>
            <ul>
                <li>輸入鍵盤按鍵，就會輸入注音或標點符號，在標準鍵盤下：</li>
                <ul>
                    <li>Shift + , 輸入逗號</li>
                    <li>Shift + . 輸入句號</li>
                    <li>Shift + / 輸入問號</li>
                </ul>

                <li>空白鍵選字</li>
                <li>按下 ` 會出現符號表</li>
                <li>按一下 Shift 用來切換中英文</li>
            </ul>
        </div>
    </div>
</bodY>


<script lang="javascript" src="../public/bundle.js"></script>
<script lang="javascript">
    var chineseMode = true;
    function resetUI() {
        let s = chineseMode ? "【麥】" : "【英】"
        s += "<span class='cursor'>|</span>";
        document.getElementById("composing_buffer").innerHTML = s;
        document.getElementById("candidates").innerHTML = "";
    }

    let ui = function () {
        let that = {};
        that.reset = resetUI;

        that.commitString = function (string) {
            var selectionStart = document.getElementById("text_area").selectionStart;
            var selectionStop = document.getElementById("text_area").selectionStop;
            var text = document.getElementById("text_area").value;
            var head = text.substring(0, selectionStart);
            var tail = text.substring(selectionStart);
            document.getElementById("text_area").value = (head + string + tail);
            let start = selectionStart + string.length;
            document.getElementById("text_area").setSelectionRange(start, start)
        };

        that.update = function (string) {
            let state = JSON.parse(string);
            {
                let buffer = state.composingBuffer;
                let s = chineseMode ? "【麥】" : "【英】";
                let i = 0;
                for (let item of buffer) {
                    let text = item.text;
                    for (let c of text) {
                        if (i === state.cursorIndex) {
                            s += "<span class='cursor'>|</span>";
                        }
                        s += c;
                        i++;
                    }

                }
                if (i === state.cursorIndex) {
                    s += "<span class='cursor'>|</span>";
                }
                document.getElementById("composing_buffer").innerHTML = s;
            }

            if (state.candidates.length) {
                let s = "<table><tr>"
                for (let candidate of state.candidates) {
                    s += "<td>";
                    if (candidate.selected) s += "<b>";
                    s += candidate.keyCap;
                    if (candidate.selected) s += "</b>";
                    s += "</td>";
                    s += "<td>";
                    if (candidate.selected) s += "<b>";
                    s += candidate.candidate;
                    if (candidate.selected) s += "</b>";
                    s += "</td>";
                    if (candidate.selected) s += "</b>";
                }
                s += "</tr></table>";
                document.getElementById("candidates").innerHTML = s;
            }

        };

        return that;
    }();
    const { InputController } = window.mcbopomofo;
    let controller = new InputController(ui);
    let shiftState = false;

    document.getElementById("text_area").addEventListener('keyup', (event) => {
        if (event.key === "Shift" && shiftState) {
            shiftState = false;
            chineseMode = !chineseMode;
            controller.reset();
            return;
        }
    });

    document.getElementById("text_area").addEventListener('keydown', (event) => {
        console.log(event);

        if (event.key === "Shift") {
            shiftState = true;
        } else {
            shiftState = false;
        }

        if (!chineseMode) {
            return;
        }

        let accepted = controller.keyEvent(event);
        if (accepted) {
            event.preventDefault();
        }
    });


    document.getElementById("layout").onchange = function (event) {
        let value = document.getElementById("layout").value;
        controller.setKeyboardLayout(value);
        document.getElementById("text_area").focus();
    };

    document.getElementById("keys").onchange = function (event) {
        let value = document.getElementById("keys").value;
        controller.setCandidateKeys(value);
        document.getElementById("text_area").focus();
    };

    document.getElementById("before_cursor").onchange = function (event) {
        controller.setSelectPhrase("before_cursor");
        document.getElementById("text_area").focus();
    };

    document.getElementById("after_cursor").onchange = function (event) {
        controller.setSelectPhrase("after_cursor");
        document.getElementById("text_area").focus();
    };

    document.getElementById("esc_key").onchange = function (event) {
        let checked = document.getElementById("esc_key").checked;
        controller.setEscClearEntireBuffer(checked);
        document.getElementById("text_area").focus();
    };

    document.getElementById("uppercase_letters").onchange = function (event) {
        controller.setLetterMode("upper");
        document.getElementById("text_area").focus();
    };

    document.getElementById("lowercase_letters").onchange = function (event) {
        controller.setLetterMode("lower");
        document.getElementById("text_area").focus();
    };

    document.getElementById("move_cursor").onchange = function (event) {
        let checked = document.getElementById("move_cursor").checked;
        console.log("checked");
        console.log(checked);
        controller.setMoveCursorAfterSelection(checked);
        document.getElementById("text_area").focus();
    };

    document.getElementById("fullscreen").onclick = function (event) {
        let elem = document.getElementById("edit_area");
        if (elem.requestFullscreen) {
            elem.requestFullscreen();
        } else if (elem.msRequestFullscreen) {
            elem.msRequestFullscreen();
        } else if (elem.mozRequestFullScreen) {
            elem.mozRequestFullScreen();
        } else if (elem.webkitRequestFullscreen) {
            elem.webkitRequestFullscreen();
        }
        document.getElementById("text_area").focus();
        return false;
    }

    document.getElementById("loading").innerText = "小麥注音輸入法載入完畢！";
    resetUI();
    document.getElementById("text_area").focus();

</script>


</html>